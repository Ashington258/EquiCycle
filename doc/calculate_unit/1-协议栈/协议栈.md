# 多数据流局域网平台协议栈

构建舵机和视频的完整协议栈需要根据实时性需求、网络特性和传输稳定性，合理设计每层的功能。以下是针对舵机控制数据和视频流的完整协议栈设计。

---

## **舵机控制数据协议栈**

### **应用层**
- **功能**：
  - 定义舵机控制指令格式。
  - 解析接收数据并执行相应的控制逻辑。
- **数据帧格式**（用户之前提到的帧格式为例）：
  ```
  +------------+-----------------+-------+------------+
  | Frame Head | Control Data    | CRC   | Frame Tail |
  +------------+-----------------+-------+------------+
  ```
  - **Frame Head**: 固定标志位 (0x30)。
  - **Control Data**: 舵机控制指令，使用小端模式存储，具体值由协议定义（如舵机角度或脉宽值）。
  - **CRC**: 校验字段，用于错误检测。
  - **Frame Tail**: 固定标志位 (0x40)。



### **传输层**
- **协议**：UDP
  - 选择 UDP 是因为其低延迟特性，适用于实时控制需求。
- **优化措施**：
  - 数据包长度控制在 MTU 之内，避免分片。
  - 增加简单的 ACK 机制（可选），用于确认关键指令是否到达。

### **网络层**
- **协议**：IPv4
  - 使用私有 IP 地址（如 192.168.x.x）。
  - 在局域网环境中，使用静态 IP 或动态分配（DHCP）。

### **数据链路层**
- **协议**：以太网（Ethernet）
  - 数据帧通过局域网交换机传输。
  - 优先使用千兆以太网以降低延迟。

---

## **视频流协议栈**

### **应用层**
- **协议**：HTTP (Flask) 或 WebSocket
  - **HTTP**：
    - 使用 Flask 的 `Response` 方法实现视频流。
    - 视频数据以 `multipart/x-mixed-replace` 的方式连续传输。
  - **WebSocket**：
    - 提供全双工通信，降低延迟。
    - 适用于实时性要求更高的场景。
  - **数据格式**：
    - **MJPEG**：每一帧编码为 JPEG 格式，适合传输动态帧。
    - **H.264/HEVC**：适合带宽有限但延迟较高的情况。

### **传输层**
- **协议**：TCP 或 UDP
  - **TCP**（适用于 HTTP）：
    - 确保数据完整性，适合视频流传输。
    - 避免丢帧导致的图像损坏。
  - **UDP**（适用于 WebSocket 或 RTSP）：
    - 更低的传输延迟，适合实时视频。
    - 可通过丢帧策略容忍少量数据丢失。

### **网络层**
- **协议**：IPv4
  - 与舵机控制数据共用网络层配置。
  - 如果使用多设备，确保路由器的流量分配均衡。

### **数据链路层**
- **协议**：以太网（Ethernet）
  - 和舵机控制数据使用相同的局域网。
  - 优先分配带宽给视频流，避免视频卡顿。

---

## **协议栈对比与整合**

| **层次**       | **舵机控制数据**              | **视频流**                        |
| -------------- | ----------------------------- | --------------------------------- |
| **应用层**     | 自定义协议（控制指令 + 校验） | HTTP/Flask, WebSocket, RTSP       |
| **传输层**     | UDP                           | TCP（HTTP）/UDP（WebSocket/RTSP） |
| **网络层**     | IPv4                          | IPv4                              |
| **数据链路层** | 以太网（Ethernet）            | 以太网（Ethernet）                |

---

## **实现注意事项**
1. **独立传输通道**：
   - 视频流和舵机控制数据分开传输，避免相互干扰。
   - 舵机使用固定的 UDP 端口，视频流使用 HTTP/RTSP 的端口。
2. **数据优先级管理**：
   - 路由器或交换机上设置 QoS（Quality of Service），优先保证舵机控制数据的实时性。
3. **同步机制**：
   - 在应用层通过时间戳同步视频帧和舵机控制指令。
4. **网络性能监控**：
   - 使用工具（如 `tcpdump` 或 Wireshark）分析延迟、丢包率等。

这种协议栈设计能有效满足视频流和舵机控制数据的实时传输需求，同时具备灵活性和可扩展性。